# AI Coach V2 Production Status

**Last Updated:** 2026-02-09  
**Branch:** `main`  
**Intent:** Track implementation status, production gates, and test evidence for V2 rollout.
**Canonical Implementation Spec:** `/Users/natekahl/ITM-gd/docs/ai-coach/AI_COACH_V2_REBUILD_SPEC.md` (source import from `/Users/natekahl/Desktop/AI_COACH_V2_REBUILD_SPEC.pdf`)

All phase decisions, testing gates, and acceptance criteria in this status document should be interpreted against the rebuild spec above.

## 1) Delivered on `Aiupgrade`

### Backend
- Watchlist API with default recovery:
  - `GET/POST/PUT/DELETE /api/watchlist`
  - `/Users/natekahl/ITM-gd/backend/src/routes/watchlist.ts`
- Morning brief API:
  - `GET/PATCH /api/brief/today`
  - Supports:
    - 30-min freshness cache
    - `force=true` regeneration
    - `watchlist=...` on-demand preview
  - `/Users/natekahl/ITM-gd/backend/src/routes/brief.ts`
- Morning brief generation service:
  - Builds key levels, macro events, open-position risk summary, watch items
  - `/Users/natekahl/ITM-gd/backend/src/services/morningBrief/index.ts`
- Morning brief scheduler worker:
  - Runs at/after 7:00 AM ET on trading days
  - Idempotent inserts by `(user_id, market_date)` (skips existing)
  - Startup/shutdown lifecycle integrated in server
  - `/Users/natekahl/ITM-gd/backend/src/workers/morningBriefWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`
- Tracked setups API:
  - `GET/POST/PATCH/DELETE /api/tracked-setups`
  - Duplicate-safe behavior for active `source_opportunity_id`
  - `/Users/natekahl/ITM-gd/backend/src/routes/trackedSetups.ts`
- Scanner integration:
  - Uses user watchlist symbols when query symbols are omitted
  - `/Users/natekahl/ITM-gd/backend/src/routes/scanner.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functionHandlers.ts`
- Symbol unlock + search API (Phase 1 foundation hardening):
  - Removed SPX/NDX-only gating from levels/options/GEX route layer and scanner/chat defaults now use a broader popular watchlist set
  - Removed SPX/NDX-only validation from macro impact route (`GET /api/macro/impact/:symbol`) so any valid ticker format now works
  - WebSocket symbol subscriptions now accept any validated ticker format instead of a fixed allowlist
  - Added `GET /api/symbols/search?q=<query>&limit=20` with 24h Redis caching and Massive reference ticker lookup
  - Added shared symbol normalization/validation utilities for route/service consistency
  - `/Users/natekahl/ITM-gd/backend/src/routes/levels.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/options.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/scanner.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/macro.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/symbols.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/gexCalculator.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/websocket.ts`
  - `/Users/natekahl/ITM-gd/backend/src/config/massive.ts`
  - `/Users/natekahl/ITM-gd/backend/src/lib/symbols.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/macroValidation.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/symbolsValidation.ts`
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`
- Setup push worker scaffolding (timing + lifecycle hooks):
  - Adaptive polling worker with start/stop during server lifecycle
  - Heartbeat event channel for future setup-delivery integration
  - `/Users/natekahl/ITM-gd/backend/src/workers/setupPushWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupPushChannel.ts`
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`
- Setup transition automation + targeted push delivery:
  - Evaluates `active` tracked setups against live price and suggested trade levels
  - Persists `active -> triggered|invalidated` with timestamps
  - Publishes user-targeted `setup_update` events to WebSocket channel `setups:{userId}`
  - `/Users/natekahl/ITM-gd/backend/src/workers/setupPushWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/websocket.ts`
- Worker health telemetry + endpoint:
  - In-memory lifecycle/heartbeat metrics for `alert`, `morning_brief`, `setup_push`, and `setup_detector` workers
  - Health endpoint `GET /health/workers` returns running/stale summary and per-worker stats
  - `/Users/natekahl/ITM-gd/backend/src/services/workerHealth.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/health.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/alertWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/morningBriefWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/setupPushWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/index.ts`
- Worker health external alerting (Discord-first, Sentry optional):
  - New worker monitors `workerHealth` telemetry and sends Discord incident alerts for stale/unresolved-failure workers
  - Includes cooldown-based de-duplication and recovery notifications
  - Optional Sentry incident messages tied to worker name/type
  - Configurable via env (`WORKER_ALERTS_*`)
  - `/Users/natekahl/ITM-gd/backend/src/workers/workerHealthAlertWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/workerHealthAlerting.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/discordNotifier.ts`
  - `/Users/natekahl/ITM-gd/backend/src/config/env.ts`
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`
  - `/Users/natekahl/ITM-gd/backend/.env.example`
- GEX profile API + AI function:
  - `GET /api/options/:symbol/gex` with validated query params (`expiry`, `strikeRange`, `maxExpirations`, `forceRefresh`) and 5-min cached calculator service
  - ChatKit function `get_gamma_exposure` wired to return regime, flip point, max GEX strike, key levels, and strike-by-strike GEX
  - `/Users/natekahl/ITM-gd/backend/src/routes/options.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/optionsValidation.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/gexCalculator.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functions.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functionHandlers.ts`
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`
- 0DTE toolkit backend slice (Phase 3 sequential start):
  - New service `analyzeZeroDTE(symbol, { strike?, type? })` with:
    - expected move used/remaining
    - theta clock projections (15-min intervals)
    - gamma risk profile and leverage estimate
    - top 0DTE contracts by volume
  - New API route: `GET /api/options/:symbol/0dte`
  - New ChatKit function: `get_zero_dte_analysis`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/zeroDTE.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/options.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functions.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functionHandlers.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/types.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/optionsValidation.ts`
- IV Intelligence backend slice (Phase 3 sequential continuation):
  - New service `analyzeIVProfile(symbol, { expiry?, strikeRange?, maxExpirations?, forceRefresh? })` with:
    - IV rank + percentile from historical volatility proxy series
    - put/call skew analysis (`25-delta`, `10-delta`) with interpretation
    - term-structure shape classification (`contango`, `backwardation`, `flat`)
  - New API route: `GET /api/options/:symbol/iv`
  - New ChatKit function: `get_iv_analysis`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/ivAnalysis.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/options.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functions.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functionHandlers.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/types.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/optionsValidation.ts`
- Options matrix backend slice for heatmap workflows (Phase 4 sequential):
  - New API route: `GET /api/options/:symbol/matrix?expirations=5&strikes=50`
  - New service method `fetchOptionsMatrix(symbol, { expirations, strikes })`:
    - aggregates chains across multiple expirations
    - normalizes a strike/expiry matrix payload
    - computes per-cell metrics (`volume`, `openInterest`, `impliedVolatility`, `gex`)
    - caches matrix snapshots for heatmap rendering
  - Added route validation + regression tests for matrix query handling.
  - `/Users/natekahl/ITM-gd/backend/src/routes/options.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/optionsChainFetcher.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/types.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/optionsValidation.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/options.test.ts`
- Earnings module backend slice (Phase 3 sequential completion):
  - New service `EarningsService` with:
    - upcoming earnings calendar discovery (watchlist + days window)
    - free-source primary calendar feed via Alpha Vantage (`ALPHA_VANTAGE_API_KEY`) with Massive TMX fallback
    - symbol-level earnings analysis (expected move, historical move comparison, IV context, strategy suggestions)
    - Supabase-backed analysis caching via `ai_coach_earnings_cache` (4-hour TTL)
  - New API routes:
    - `GET /api/earnings/calendar?watchlist=AAPL,NVDA&days=14`
    - `GET /api/earnings/:symbol/analysis`
  - New ChatKit functions:
    - `get_earnings_calendar`
    - `get_earnings_analysis`
  - `/Users/natekahl/ITM-gd/backend/src/services/earnings/index.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/earnings.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/earningsValidation.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functions.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functionHandlers.ts`
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`
- Chart timeframe stability hardening (index volume normalization + frontend guardrails):
  - Normalized missing Massive index volume (`SPX`/`NDX`) to `0` in chart API responses to keep response shape stable across all timeframes.
  - Added numeric bar sanitization in backend chart routes/services.
  - Added frontend chart data guardrails (sorted/deduped bars, finite checks, safe volume fallback) to prevent rendering crashes on timeframe switches.
  - Added route regression tests for missing-volume index bars.
  - `/Users/natekahl/ITM-gd/backend/src/routes/chart.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/charts/chartDataService.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/chart.test.ts`
  - `/Users/natekahl/ITM-gd/components/ai-coach/trading-chart.tsx`
- Massive indicator endpoint integration (Phase 4 groundwork):
  - Added typed Massive indicator clients for `EMA`, `SMA`, `RSI`, and `MACD` (`/v1/indicators/*`) with validated query shaping.
  - Extended chart route with `includeIndicators=true` support and provider payload:
    - `providerIndicators: { source, timespan, ema8, ema21, rsi14, macd }`
  - Indicator failures now degrade gracefully to empty series while preserving successful chart-bar responses.
  - Added chart route regression coverage for indicator inclusion and fallback behavior.
  - `/Users/natekahl/ITM-gd/backend/src/config/massive.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/chart.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/chartValidation.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/chart.test.ts`
- Options chain loading hotfix (Massive API contract alignment):
  - Fixed Massive single-contract snapshot parsing (`results` object vs array) so `/api/options/:symbol/chain` no longer drops all contracts.
  - Added safer snapshot field handling for partial payloads.
  - Added options contracts pagination for expiry-specific pulls (required for full strike coverage near ATM).
  - Added fast nearest-expiration lookup to avoid heavy full-chain pagination in standard chain requests.
  - `/Users/natekahl/ITM-gd/backend/src/config/massive.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/optionsChainFetcher.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/__tests__/optionsChainFetcher.test.ts`
- SPX/NDX options analytics accuracy hardening (Massive index snapshot + ET date normalization):
  - Massive option snapshots now use index-prefixed underlyings (`I:SPX`, `I:NDX`, etc.) so Greeks and implied volatility are populated correctly for index contracts.
  - Added fallback Greek calculation when provider IV is present but provider Greeks are missing.
  - Expiration discovery/filtering now uses US Eastern market date (not UTC date) to avoid false `No 0DTE expiration found` windows around UTC midnight.
  - Added regression tests for index snapshot mapping and ET expiration filtering.
  - `/Users/natekahl/ITM-gd/backend/src/config/massive.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/optionsChainFetcher.ts`
  - `/Users/natekahl/ITM-gd/backend/src/config/__tests__/massive-options-snapshot.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/__tests__/optionsChainFetcher.test.ts`
- Member dashboard/journal auth + RPC resilience hardening:
  - Unified API auth for member journal routes to accept either bearer token or server-session cookies through shared request auth utility.
  - Dashboard endpoints (`stats`, `equity-curve`, `calendar`) now:
    - authenticate via bearer/cookie path consistently
    - normalize RPC response shapes for frontend expectations
    - gracefully fall back to direct `journal_entries` aggregation when RPC functions are unavailable in an environment.
  - Dashboard frontend widgets now wait for member auth readiness and include bearer token headers on member API calls to prevent transient 401 loops.
  - `/Users/natekahl/ITM-gd/lib/request-auth.ts`
  - `/Users/natekahl/ITM-gd/app/api/members/journal/route.ts`
  - `/Users/natekahl/ITM-gd/app/api/members/journal/enrich/route.ts`
  - `/Users/natekahl/ITM-gd/app/api/members/journal/replay/[entryId]/route.ts`
  - `/Users/natekahl/ITM-gd/app/api/members/dashboard/stats/route.ts`
  - `/Users/natekahl/ITM-gd/app/api/members/dashboard/equity-curve/route.ts`
  - `/Users/natekahl/ITM-gd/app/api/members/dashboard/calendar/route.ts`
  - `/Users/natekahl/ITM-gd/components/dashboard/ai-insights.tsx`
  - `/Users/natekahl/ITM-gd/components/dashboard/recent-trades.tsx`
  - `/Users/natekahl/ITM-gd/components/dashboard/equity-curve.tsx`
  - `/Users/natekahl/ITM-gd/components/dashboard/calendar-heatmap.tsx`
  - `/Users/natekahl/ITM-gd/components/dashboard/dashboard-stat-cards.tsx`
- Options expirations performance hardening:
  - Reduced expiration discovery path to a lightweight near-term fetch to prevent timeout regressions on `SPX/NDX` `0DTE` and `IV` routes.
  - `/Users/natekahl/ITM-gd/backend/src/config/massive.ts`
- Real-time setup detector service:
  - Implements ORB, break-retest, VWAP play, gap-fill, volume climax, level-test, gamma squeeze, and SPX/NDX opening-drive detectors
  - Runs on market-aware cadence and persists deduplicated detections to `ai_coach_detected_setups`
  - Auto-creates tracked setups for watchlist users (1 setup per symbol/user per 5 min) and publishes `setup_detected` events
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/index.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/detectors.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/gammaSqueeze.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/indexSpecific.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/volumeClimax.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/levelTest.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/orb.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/breakRetest.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/vwap.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/gapFill.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupPushChannel.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/websocket.ts`
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`
- Backend-integrated E2E auth bypass lane (non-production only):
  - `authenticateToken` now supports `Bearer e2e:<uuid>` (or `Bearer e2e:<shared-secret>:<uuid>` when secret is configured) when `E2E_BYPASS_AUTH=true`
  - Auto-provisions the bypass UUID in Supabase Auth for FK-safe watchlist/tracked/brief flows
  - Env-gated by `E2E_BYPASS_AUTH`, `E2E_BYPASS_TOKEN_PREFIX`, and optional `E2E_BYPASS_SHARED_SECRET`
  - `/Users/natekahl/ITM-gd/backend/src/middleware/auth.ts`
  - `/Users/natekahl/ITM-gd/backend/src/config/env.ts`
  - `/Users/natekahl/ITM-gd/backend/.env.example`
  - `/Users/natekahl/ITM-gd/backend/README.md`
- Staging CORS compatibility for live E2E browser lane:
  - Added `x-e2e-bypass-auth` to CORS allowed headers so Playwright middleware bypass header is accepted in browser preflight requests.
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`
- Deterministic detector auto-track E2E hook (non-production only):
  - `POST /api/tracked-setups/e2e/simulate-detected` creates `ai_coach_detected_setups` + `ai_coach_tracked_setups`, then emits `setup_detected`
  - Hard-gated to non-production and requires `E2E_BYPASS_AUTH=true`
  - Used by live workflow to validate detector-driven tracked setup flow without direct tracked setup API seeding
  - `/Users/natekahl/ITM-gd/backend/src/routes/trackedSetups.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/trackedSetupsValidation.ts`
- Phase 5 live position tracking + exit advisor backend slice:
  - DB-backed open-position loading implemented in `positionAnalyzer` (`getUserPositions`, `getPositionById`)
  - New live position tracker service with persisted `current_price/current_value/pnl/pnl_pct/greeks` refresh
  - New exit advisor rules engine covering:
    - profit taking
    - loss management
    - time-decay warnings
    - spread conversion suggestions
    - roll suggestions
  - New position push channel + WebSocket fanout on `positions:{userId}`:
    - `position_update`
    - `position_advice`
  - New adaptive polling worker `position_tracker_worker` (15s market-active / 60s closed) with `workerHealth` telemetry
  - New APIs:
    - `GET /api/positions/live`
    - `GET /api/positions/advice?positionId=<uuid>`
  - New ChatKit function:
    - `get_position_advice`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/positionAnalyzer.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/positions/liveTracker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/positions/exitAdvisor.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/positionPushChannel.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/websocket.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/positionTrackerWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/options.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/optionsValidation.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functions.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functionHandlers.ts`
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`
- Phase 5 journal auto-population + pattern recognition backend slice (sequential continuation):
  - New auto-population service for EOD draft journal generation (4:15 PM ET) from:
    - tracked setups
    - triggered alerts
    - position lifecycle events
    - AI conversation symbol mentions
  - New weekly pattern analyzer for journal insights (Sunday evening) with:
    - time-of-day win-rate/P&L buckets
    - setup-level performance breakdown
    - behavioral signals (revenge-trading and overtrading correlation)
    - risk-management signals (realized R/R proxy, stop adherence, sizing consistency)
  - New workers:
    - `journal_autopopulate_worker`
    - `journal_insights_worker`
  - New journal APIs:
    - `GET /api/journal/drafts`
    - `POST /api/journal/drafts/generate`
    - `PATCH /api/journal/trades/:id/draft-status`
    - `GET /api/journal/insights`
  - New ChatKit function:
    - `get_journal_insights`
  - `/Users/natekahl/ITM-gd/backend/src/services/journal/autoPopulate.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/journal/patternAnalyzer.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/journalAutoPopulateWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/journalInsightsWorker.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/journal.ts`
  - `/Users/natekahl/ITM-gd/backend/src/schemas/journalValidation.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functions.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/functionHandlers.ts`
  - `/Users/natekahl/ITM-gd/backend/src/server.ts`

### Frontend
- Opportunity Scanner:
  - Pulls default watchlist from API
  - Edit/save watchlist in-panel
  - Track setup actions with status states (`saving/saved/duplicate/error`)
  - `/Users/natekahl/ITM-gd/components/ai-coach/opportunity-scanner.tsx`
- Morning Brief panel:
  - Summary, watchlist chips, key levels, economic events, open-position risk, watch items
  - `/Users/natekahl/ITM-gd/components/ai-coach/morning-brief.tsx`
- Center panel wiring:
  - Morning Brief tab + home access
  - Tracked Setups tab + home quick access
  - `/Users/natekahl/ITM-gd/components/ai-coach/center-panel.tsx`
- Tracked setups management panel:
  - Status filters (`active/triggered/invalidated/archived/all`)
  - Lifecycle actions (trigger/invalidate/archive/reopen)
  - Notes editing + delete + AI follow-up action
  - Live refresh via WebSocket `setups:{userId}` for both `setup_update` and `setup_detected` events
  - `/Users/natekahl/ITM-gd/components/ai-coach/tracked-setups-panel.tsx`
- Typed API client coverage:
  - watchlist/brief/tracked-setups methods
  - `/Users/natekahl/ITM-gd/lib/api/ai-coach.ts`
- Phase 5 live position tracker frontend slice:
  - Replaced static Position Analyze center view with a live Position Tracker panel
  - New live API bindings:
    - `getLivePositions`
    - `getPositionAdvice`
  - WebSocket subscription to `positions:{userId}` for in-session `position_update` and `position_advice` events
  - Position cards now render live P&L/Greeks/DTE + actionable prompts:
    - Close
    - Roll
    - Convert to Spread
    - Set Stop
  - `/Users/natekahl/ITM-gd/components/ai-coach/position-tracker.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/center-panel.tsx`
  - `/Users/natekahl/ITM-gd/lib/api/ai-coach.ts`
- Phase 5 journal insights frontend slice:
  - New Journal Insights card in the Journal Analytics tab with period switch (`7d/30d/90d`) and refresh controls.
  - New API client support for draft workflows and insights:
    - `getDraftTrades`
    - `generateJournalDrafts`
    - `updateTradeDraftStatus`
    - `getJournalInsights`
  - `/Users/natekahl/ITM-gd/components/ai-coach/journal-insights.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/trade-journal.tsx`
  - `/Users/natekahl/ITM-gd/lib/api/ai-coach.ts`
- GEX frontend visualization + chart overlay wiring:
  - Reusable GEX visualization component `GEXChart`
  - Chat widget card rendering for `get_gamma_exposure` with regime/flip/max/key levels and a `Show on Chart` action
  - Options panel now loads `/api/options/:symbol/gex` and renders embedded GEX profile + chart handoff action
  - Center panel chart request plumbing now accepts GEX payloads and renders flip/max/key overlays on `TradingChart`
  - `/Users/natekahl/ITM-gd/components/ai-coach/gex-chart.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/widget-cards.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/options-chain.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/center-panel.tsx`
  - `/Users/natekahl/ITM-gd/hooks/use-ai-coach-chat.ts`
  - `/Users/natekahl/ITM-gd/lib/api/ai-coach.ts`
- Options Intelligence dashboard expansion (Phase 3 continuation):
  - Added `0DTE` and `IV` dashboard cards to options panel with live backend wiring and refresh controls.
  - Added API client bindings for `/api/options/:symbol/0dte` and `/api/options/:symbol/iv`.
  - New components:
    - `/Users/natekahl/ITM-gd/components/ai-coach/zero-dte-dashboard.tsx`
    - `/Users/natekahl/ITM-gd/components/ai-coach/iv-dashboard.tsx`
  - Updated integration:
    - `/Users/natekahl/ITM-gd/components/ai-coach/options-chain.tsx`
    - `/Users/natekahl/ITM-gd/lib/api/ai-coach.ts`
- Options Heatmap frontend slice (Phase 4 sequential):
  - Added new canvas-based `OptionsHeatmap` component with:
    - 2D strike/expiry grid rendering
    - mode selector (`Volume`, `Open Interest`, `IV`, `GEX`)
    - hover tooltip + click-to-inspect contract detail panel
    - mouse-wheel zoom on strike density
  - Added Options sub-tab switching (`Chain` / `Heatmap`) and matrix controls (expirations + strike range).
  - Added API client typing/binding for `/api/options/:symbol/matrix`.
  - `/Users/natekahl/ITM-gd/components/ai-coach/options-heatmap.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/options-chain.tsx`
  - `/Users/natekahl/ITM-gd/lib/api/ai-coach.ts`
- Earnings dashboard integration (Phase 3 completion):
  - Added `Earnings` center-panel tab with event calendar + analysis view.
  - Added earnings dashboard with:
    - watchlist/date-window calendar control
    - symbol-level expected move + historical move comparison
    - strategy cards and IV-crush simulator
  - `/Users/natekahl/ITM-gd/components/ai-coach/earnings-dashboard.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/center-panel.tsx`
  - `/Users/natekahl/ITM-gd/contexts/AICoachWorkflowContext.tsx`
  - `/Users/natekahl/ITM-gd/lib/api/ai-coach.ts`
- Cross-widget workflow/action framework (production pass):
  - Shared workflow context with symbol/strike/expiry sync, center-view routing, breadcrumb path, and alert prefill state
  - Reusable widget action primitives (`widget-actions`, `widget-action-bar`, `widget-context-menu`) wired into key widgets
  - Key levels, options, scanner, current price, alerts, and GEX cards now expose chart/options/alert/analyze/chat actions via a unified action layer
  - Options panel now supports workflow symbol-sync prompts and workflow strike highlighting
  - Alerts panel consumes workflow prefill for one-click alert creation from widgets
  - `/Users/natekahl/ITM-gd/contexts/AICoachWorkflowContext.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/widget-actions.ts`
  - `/Users/natekahl/ITM-gd/components/ai-coach/widget-action-bar.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/widget-context-menu.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/widget-cards.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/center-panel.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/options-chain.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/alerts-panel.tsx`
  - `/Users/natekahl/ITM-gd/app/members/ai-coach/page.tsx`
- Phase 6 workflow polish slice (sequential continuation):
  - Added reusable workflow breadcrumb component for center-panel navigation path rendering.
  - Added persisted user preferences panel (`Prefs` tab + welcome quick action) with local defaults for:
    - risk per trade
    - opening range window
    - default chart timeframe
    - default chart overlays
    - workflow symbol sync mode
    - options defaults (strike range, GEX, 0DTE/IV visibility)
  - Chart now consumes configurable opening-range window preference (`5/15/30` minutes).
  - Options panel now supports preference-driven default toggles and auto-sync workflow symbol mode.
  - Chart panel now supports preference-driven symbol sync behavior:
    - `autoSyncWorkflowSymbol=true` auto-applies workflow symbol transitions
    - otherwise shows an explicit sync prompt (`Yes/No`) when workflow symbol diverges
  - `/Users/natekahl/ITM-gd/components/ai-coach/workflow-breadcrumb.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/preferences-panel.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/preferences.ts`
  - `/Users/natekahl/ITM-gd/components/ai-coach/center-panel.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/trading-chart.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/options-chain.tsx`
  - `/Users/natekahl/ITM-gd/contexts/AICoachWorkflowContext.tsx`
- Non-widget workflow action extension (scanner/tracked/chart surfaces):
  - Opportunity Scanner cards now support context-menu + action-bar workflow handoffs (chart/options/alerts/analyze/chat)
  - Tracked Setups cards now support setup-overlay chart actions (entry/stop/target), context actions, and production handoffs to options/alerts/analyze/chat
  - Chart view now exposes native right-click workflow actions at hovered price (chart focus/options/alert/chat)
  - `/Users/natekahl/ITM-gd/components/ai-coach/opportunity-scanner.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/tracked-setups-panel.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/center-panel.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/trading-chart.tsx`
- Chart overlay controls and indicator-state wiring:
  - Added centralized indicator config (`EMA 8`, `EMA 21`, `VWAP`, `OR`, `RSI`, `MACD`) and toolbar panel toggles.
  - Wired indicator config from center panel into chart toolbar + trading chart overlays.
  - Promoted RSI/MACD from placeholder toggles to live chart panes with Massive provider data and local-calculation fallback.
  - Added reusable chart-indicator utility module for EMA/VWAP/OR/RSI/MACD series calculations.
  - `/Users/natekahl/ITM-gd/components/ai-coach/center-panel.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/chart-toolbar.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/chart-indicators.ts`
  - `/Users/natekahl/ITM-gd/components/ai-coach/trading-chart.tsx`
  - `/Users/natekahl/ITM-gd/lib/api/ai-coach.ts`
- SymbolSearch UX integration (spec alignment):
  - Added reusable symbol autocomplete component with debounce, favorites, recents, and categorized suggestions
  - Wired into options chain symbol selector, position analysis form symbol selector, chart toolbar symbol selector, and scanner watchlist edit flow
  - Uses backend `GET /api/symbols/search` when authenticated with popular-symbol fallback
  - `/Users/natekahl/ITM-gd/components/ai-coach/symbol-search.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/options-chain.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/position-form.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/chart-toolbar.tsx`
  - `/Users/natekahl/ITM-gd/components/ai-coach/opportunity-scanner.tsx`
  - `/Users/natekahl/ITM-gd/lib/api/ai-coach.ts`
- E2E deterministic auth/scanner harness for middleware-protected AI Coach routes:
  - Test-only auth bypass in middleware and member auth context, enabled by explicit E2E env flags
  - Development/E2E CSP `connect-src` now allows local AI Coach backend (`localhost:3001`) outside production
  - `/Users/natekahl/ITM-gd/middleware.ts`
  - `/Users/natekahl/ITM-gd/contexts/MemberAuthContext.tsx`
  - `/Users/natekahl/ITM-gd/playwright.config.ts`
  - `/Users/natekahl/ITM-gd/e2e/helpers/member-auth.ts`
- Live backend-integrated AI Coach test lane (opt-in):
  - Shared live-mode test helper (`E2E_AI_COACH_MODE=live`, backend URL/auth headers)
  - New live workflow spec executes scanner -> tracked lifecycle -> brief against real backend APIs (no route mocks)
  - Added live authenticated earnings endpoint checks for:
    - `GET /api/earnings/calendar`
    - `GET /api/earnings/:symbol/analysis` (supports transient provider-unavailable `503` contract in test assertions)
  - API health spec now includes authenticated watchlist/scanner/brief + tracked lifecycle checks in live mode
  - Strict CI gate mode via `E2E_AI_COACH_REQUIRE_LIVE=true` (fails instead of skip when live prerequisites are missing)
  - Dedicated workflow dispatch gate for staging live E2E
  - Live workflow now validates detector path through simulated `setup_detected` auto-track hook before status management and brief flow
  - `/Users/natekahl/ITM-gd/e2e/helpers/ai-coach-live.ts`
  - `/Users/natekahl/ITM-gd/e2e/specs/ai-coach/ai-coach-workflow-live.spec.ts`
  - `/Users/natekahl/ITM-gd/e2e/specs/ai-coach/ai-coach-api.spec.ts`
  - `/Users/natekahl/ITM-gd/playwright.config.ts`
  - `/Users/natekahl/ITM-gd/.github/workflows/ai-coach-live-e2e.yml`
  - `/Users/natekahl/ITM-gd/scripts/ai-coach/validate-earnings-endpoints.sh`
  - `/Users/natekahl/ITM-gd/docs/ai-coach/AI_COACH_V2_STAGING_GATE_RUNBOOK.md`

### Database
- Applied to staging:
  - `20260304100000_journal_security_and_backfill.sql`
  - `20260304103000_ai_coach_v2_tables.sql`
  - `20260304110000_ai_coach_tracked_setups.sql`
- Files:
  - `/Users/natekahl/ITM-gd/supabase/migrations/20260304100000_journal_security_and_backfill.sql`
  - `/Users/natekahl/ITM-gd/supabase/migrations/20260304103000_ai_coach_v2_tables.sql`
  - `/Users/natekahl/ITM-gd/supabase/migrations/20260304110000_ai_coach_tracked_setups.sql`

## 2) Test Evidence

### Backend route tests
- Existing:
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/brief.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/scanner.test.ts`
- Added in this pass:
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/watchlist.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/trackedSetups.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/__tests__/setupPushWorker.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/__tests__/setupPushChannel.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/__tests__/morningBriefWorker.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/__tests__/detectors.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/__tests__/volumeClimax.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/__tests__/levelTest.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/__tests__/gammaSqueeze.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/__tests__/indexSpecific.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/setupDetector/__tests__/service.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/__tests__/workerHealth.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/__tests__/workerHealthAlerting.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/__tests__/discordNotifier.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/__tests__/workerHealthAlertWorker.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/__tests__/gexCalculator.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/options.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/__tests__/zeroDTE.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/__tests__/ivAnalysis.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/options/__tests__/optionsChainFetcher.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/symbols.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/macro.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/chatkit/__tests__/functionHandlers.test.ts` (`get_gamma_exposure`, `get_zero_dte_analysis`, `get_iv_analysis` coverage)
  - `/Users/natekahl/ITM-gd/backend/src/services/__tests__/positionPushChannel.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/positions/__tests__/exitAdvisor.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/__tests__/journalAutoPopulateWorker.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/workers/__tests__/journalInsightsWorker.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/routes/__tests__/earnings.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/services/earnings/__tests__/index.test.ts`
  - `/Users/natekahl/ITM-gd/backend/src/middleware/__tests__/auth.test.ts` (JWT + E2E bypass auth middleware coverage)

### Commands
- `npm test -- --runInBand src/workers/__tests__/morningBriefWorker.test.ts src/routes/__tests__/brief.test.ts src/routes/__tests__/scanner.test.ts src/routes/__tests__/watchlist.test.ts src/routes/__tests__/trackedSetups.test.ts src/services/__tests__/setupPushChannel.test.ts src/workers/__tests__/setupPushWorker.test.ts`
- `npm test -- --runInBand src/services/setupDetector/__tests__/detectors.test.ts src/services/setupDetector/__tests__/service.test.ts src/services/__tests__/setupPushChannel.test.ts src/workers/__tests__/setupPushWorker.test.ts src/workers/__tests__/morningBriefWorker.test.ts src/routes/__tests__/brief.test.ts src/routes/__tests__/scanner.test.ts src/routes/__tests__/watchlist.test.ts src/routes/__tests__/trackedSetups.test.ts`
- `npm test -- --runInBand src/services/setupDetector/__tests__/detectors.test.ts src/services/setupDetector/__tests__/gammaSqueeze.test.ts src/services/setupDetector/__tests__/indexSpecific.test.ts src/services/setupDetector/__tests__/service.test.ts src/services/__tests__/setupPushChannel.test.ts src/workers/__tests__/setupPushWorker.test.ts src/workers/__tests__/morningBriefWorker.test.ts src/routes/__tests__/brief.test.ts src/routes/__tests__/scanner.test.ts src/routes/__tests__/watchlist.test.ts src/routes/__tests__/trackedSetups.test.ts`
- `npm test -- --runInBand src/services/setupDetector/__tests__/detectors.test.ts src/services/setupDetector/__tests__/volumeClimax.test.ts src/services/setupDetector/__tests__/levelTest.test.ts src/services/setupDetector/__tests__/gammaSqueeze.test.ts src/services/setupDetector/__tests__/indexSpecific.test.ts src/services/setupDetector/__tests__/service.test.ts src/services/__tests__/setupPushChannel.test.ts src/workers/__tests__/setupPushWorker.test.ts src/workers/__tests__/morningBriefWorker.test.ts src/routes/__tests__/brief.test.ts src/routes/__tests__/scanner.test.ts src/routes/__tests__/watchlist.test.ts src/routes/__tests__/trackedSetups.test.ts`
- `npm test -- --runInBand src/services/__tests__/workerHealth.test.ts src/services/setupDetector/__tests__/detectors.test.ts src/services/setupDetector/__tests__/volumeClimax.test.ts src/services/setupDetector/__tests__/levelTest.test.ts src/services/setupDetector/__tests__/gammaSqueeze.test.ts src/services/setupDetector/__tests__/indexSpecific.test.ts src/services/setupDetector/__tests__/service.test.ts src/services/__tests__/setupPushChannel.test.ts src/workers/__tests__/setupPushWorker.test.ts src/workers/__tests__/morningBriefWorker.test.ts src/routes/__tests__/brief.test.ts src/routes/__tests__/scanner.test.ts src/routes/__tests__/watchlist.test.ts src/routes/__tests__/trackedSetups.test.ts`
- `npm test -- --runInBand src/services/options/__tests__/gexCalculator.test.ts src/routes/__tests__/options.test.ts src/chatkit/__tests__/functionHandlers.test.ts src/chatkit/__tests__/wp8Handlers.test.ts`
- `npm test -- --runInBand src/services/options/__tests__/zeroDTE.test.ts src/routes/__tests__/options.test.ts src/chatkit/__tests__/functionHandlers.test.ts`
- `npm test -- --runInBand src/services/options/__tests__/ivAnalysis.test.ts src/routes/__tests__/options.test.ts src/chatkit/__tests__/functionHandlers.test.ts`
- `pnpm --filter titm-ai-coach-backend test -- src/services/options/__tests__/optionsChainFetcher.test.ts`
- `pnpm --filter titm-ai-coach-backend test -- src/routes/__tests__/chart.test.ts src/routes/__tests__/options.test.ts`
- `pnpm --filter titm-ai-coach-backend test -- src/services/earnings/__tests__/index.test.ts src/routes/__tests__/earnings.test.ts src/chatkit/__tests__/functionHandlers.test.ts src/routes/__tests__/options.test.ts`
- `pnpm --filter titm-ai-coach-backend test -- src/services/earnings/__tests__/index.test.ts src/routes/__tests__/earnings.test.ts src/config/__tests__/env.test.ts`
- `pnpm --filter titm-ai-coach-backend test -- src/routes/__tests__/options.test.ts src/chatkit/__tests__/functionHandlers.test.ts src/services/__tests__/positionPushChannel.test.ts src/services/positions/__tests__/exitAdvisor.test.ts`
- `pnpm --filter titm-ai-coach-backend test -- src/routes/__tests__/journal.test.ts src/chatkit/__tests__/functionHandlers.test.ts src/workers/__tests__/journalAutoPopulateWorker.test.ts src/workers/__tests__/journalInsightsWorker.test.ts`
- `pnpm --filter titm-ai-coach-backend build`
- `pnpm build` (frontend Next.js production build passes with options + earnings dashboard surfaces)
- `cd backend && LOG_LEVEL=error pnpm exec tsx -e "import { fetchOptionsChain } from './src/services/options/optionsChainFetcher'; const run=async()=>{for (const s of ['SPX','NDX','SPY','AAPL']){const c=await fetchOptionsChain(s, undefined, 2); console.log(JSON.stringify({symbol:s,expiry:c.expiry,calls:c.options.calls.length,puts:c.options.puts.length,current:c.currentPrice}));}}; run().catch((e)=>{console.error(e?.message||e);process.exit(1);});"`
- `npm test -- --runInBand src/routes/__tests__/options.test.ts src/routes/__tests__/scanner.test.ts src/routes/__tests__/symbols.test.ts src/services/options/__tests__/gexCalculator.test.ts`
- `npm test -- --runInBand src/routes/__tests__/macro.test.ts src/services/macro/__tests__/macroContext.test.ts src/chatkit/__tests__/wp8Handlers.test.ts`
- `npm test -- --runInBand src/workers/__tests__/workerHealthAlertWorker.test.ts src/services/__tests__/discordNotifier.test.ts src/services/__tests__/workerHealthAlerting.test.ts src/services/__tests__/workerHealth.test.ts`
- `npm test -- --runInBand src/middleware/__tests__/auth.test.ts`
- `pnpm ai-coach:staging:secrets`
- `pnpm ai-coach:staging:preflight` (now returns `READY`)
- `E2E_AI_COACH_MODE=live E2E_AI_COACH_REQUIRE_LIVE=true E2E_BACKEND_URL=https://itm-gd-staging.up.railway.app NEXT_PUBLIC_AI_COACH_API_URL=https://itm-gd-staging.up.railway.app E2E_BYPASS_TOKEN=e2e:00000000-0000-4000-8000-000000000001 pnpm test:e2e:ai-coach-live` (strict live-gate now passing against staging)
- `pnpm exec tsc --noEmit -p /tmp/tsconfig.ai-coach-symbols.json` (scoped frontend type-check for symbol-search integration files)
- `pnpm exec tsc --noEmit -p tsconfig.codex-temp.json` (scoped frontend type-check for workflow/action framework touched files)
- `pnpm exec tsc --noEmit -p /tmp/tsconfig.codex-nextphase.json` (scoped type-check for scanner/tracked/chart workflow surface upgrades)
- `pnpm exec playwright test e2e/specs/ai-coach/ai-coach-workflow.spec.ts --project=ai-coach` (passing; scanner -> track -> tracked live updates -> brief workflow)
- `pnpm test:e2e:ai-coach-live` (runs live lane; skips when live prerequisites are unavailable)
- `E2E_AI_COACH_MODE=live E2E_AI_COACH_REQUIRE_LIVE=true pnpm test:e2e:ai-coach-live` (strict gating mode; fails when live prerequisites are unavailable)
- `npm run build` (backend compile passes after making Sentry optional/no-op when package is not installed)
- Targeted TS checks run on changed backend/frontend files before merge.
- Playwright WebSocket smoke spec updated in `/Users/natekahl/ITM-gd/e2e/specs/ai-coach/ai-coach-api.spec.ts` (execution environment boots in current setup).
- Added scanner workflow smoke spec `/Users/natekahl/ITM-gd/e2e/specs/ai-coach/ai-coach-workflow.spec.ts` (mocked scanner/tracked/brief/WebSocket flow).
- Added live backend-integrated workflow spec `/Users/natekahl/ITM-gd/e2e/specs/ai-coach/ai-coach-workflow-live.spec.ts` (runs when `E2E_AI_COACH_MODE=live`).
- `E2E_AI_COACH_MODE=live pnpm exec playwright test e2e/specs/ai-coach/ai-coach-workflow-live.spec.ts e2e/specs/ai-coach/ai-coach-api.spec.ts --project=ai-coach`
  - Live authenticated checks now execute when backend/service-role prerequisites are healthy; otherwise they self-skip with explicit preflight reason.

## 3) Production Gates (Current)

### Green
- Branch is mergeable with `main` and pushed.
- Core V2 APIs are implemented and covered with route-level tests.
- Staging DB has required V2 core tables and tracked setups migration.
- Tracked setups lifecycle UI is available in AI Coach center panel.
- Setup push worker is running with startup/shutdown hooks and automated status transitions.
- WebSocket setup channels now deliver user-targeted setup updates (`setups:{userId}`).
- Morning brief scheduled worker is in place with idempotent writes.
- Setup detector service is running with ORB/break-retest/VWAP/gap-fill/volume-climax/level-test/gamma-squeeze/index-opening-drive detections, DB persistence, and watchlist-driven tracked-setup auto-creation.
- WebSocket setup channels now deliver both `setup_update` and `setup_detected` events.
- GEX backend surface from rebuild spec is live (`/api/options/:symbol/gex`, `get_gamma_exposure`, calculator service + tests).
- Earnings backend + UI surface from rebuild spec is now implemented (`/api/earnings/calendar`, `/api/earnings/:symbol/analysis`, `get_earnings_calendar`, `get_earnings_analysis`, `Earnings` tab/dashboard).
- Phase 5 live position tracking + proactive position advice slice is implemented and passing targeted tests/build:
  - `/api/positions/live`
  - `/api/positions/advice`
  - `get_position_advice`
  - WebSocket `positions:{userId}` push path
- Phase 5 journal auto-population + journal insights slice is implemented and passing targeted tests/build:
  - `/api/journal/drafts`
  - `/api/journal/drafts/generate`
  - `/api/journal/trades/:id/draft-status`
  - `/api/journal/insights`
  - `get_journal_insights`
  - workers: `journal_autopopulate_worker`, `journal_insights_worker`
- Options chain service has been patched to align with Massive snapshot response schema and locally validated with non-empty chains for `SPX`, `NDX`, `SPY`, and `AAPL`.
- Chart API/renderer path now normalized for index symbols and validated on staging for `SPX`/`NDX` (`1m`, `5m`, `15m`, `1h`, `4h`, `1D`) with stable payload shape.
- Worker-health external alerting now live through Discord webhooks with cooldown and recovery notices.
- AI Coach workflow Playwright smoke (`ai-coach-workflow.spec.ts`) now passes end-to-end in deterministic E2E mode.
- Staging live E2E workflow gate is defined in GitHub Actions (`ai-coach-live-e2e.yml`) with strict readiness mode support.
- Deterministic detector auto-track validation path is wired into live workflow/API specs via `/api/tracked-setups/e2e/simulate-detected`.
- Strict staging live gate passes locally against staging backend URL (two consecutive `16/16` passes).

### Needs Completion
- Optional CI operationalization step:
  - execute the GitHub Actions workflow dispatch (`ai-coach-live-e2e.yml`) after it is available on default branch (`main`), then archive that run URL as additional evidence.
- Optional: add PagerDuty escalation integration on top of the current Discord alert path if escalation policy requires paging.
- Execute authenticated earnings endpoint validation against staging and production after deploy:
  - `pnpm ai-coach:staging:earnings https://<backend-url> SPY`

## 4) Surgical Next Plan

1. Run `pnpm ai-coach:staging:run https://<staging-api-host>` on `main`.
2. After workflow completion, run `pnpm ai-coach:staging:earnings https://<staging-api-host> SPY`.
3. Capture and archive workflow URL + earnings command output evidence in this doc.
4. If required by operations policy, add PagerDuty escalation for critical worker incidents while keeping Discord as the primary notification channel.

## 5) Active Phase: Staging Gate Execution

Execution runbook:

- `/Users/natekahl/ITM-gd/docs/ai-coach/AI_COACH_V2_STAGING_GATE_RUNBOOK.md`

Staging preflight evidence (2026-02-09, refreshed):

- Command: `pnpm ai-coach:staging:preflight`
- Result: `READY`
- Passes:
  - workflow file exists on `Aiupgrade`
  - required repository secrets are configured/visible (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `E2E_BYPASS_TOKEN`)
  - optional `E2E_BYPASS_USER_ID` is configured
  - no pending `supabase/migrations` drift from `origin/main`
  - no extra `supabase/migrations` ahead of `origin/main`
- Warning:
  - workflow `.github/workflows/ai-coach-live-e2e.yml` is not on `main` yet (expected until merge)
  - optional `E2E_BYPASS_SHARED_SECRET` not configured (only needed if staging backend enables shared-secret bypass mode)
- Automation:
  - secret bootstrap script: `/Users/natekahl/ITM-gd/scripts/ai-coach/configure-staging-gate-secrets.sh`
  - preflight script: `/Users/natekahl/ITM-gd/scripts/ai-coach/check-staging-gate-readiness.sh`
  - dispatch script: `/Users/natekahl/ITM-gd/scripts/ai-coach/run-staging-live-gate.sh`
  - npm commands:
    - `pnpm ai-coach:staging:secrets`
    - `pnpm ai-coach:staging:preflight`
    - `pnpm ai-coach:staging:run https://<staging-api-host>`

Staging environment discovery and deploy-state evidence (2026-02-09):

- Staging backend domain:
  - `https://itm-gd-staging.up.railway.app`
- Verification snapshots (latest):
  - `GET https://itm-gd-staging.up.railway.app/health` -> `200`
  - `GET https://itm-gd-staging.up.railway.app/health/detailed` -> `200`
  - `GET https://itm-gd-staging.up.railway.app/api/watchlist` with `Authorization: Bearer e2e:00000000-0000-4000-8000-000000000001` -> `200`
  - `GET https://itm-gd-staging.up.railway.app/api/scanner/scan?symbols=SPY&include_options=false` with `Authorization: Bearer e2e:...` and `x-e2e-bypass-auth: 1` -> `200`
- Staging backend env vars confirmed for live-gate lane:
  - `E2E_BYPASS_AUTH=true`
  - `E2E_BYPASS_ALLOW_IN_PRODUCTION=true`
  - `ALLOWED_ORIGINS=https://www.tradeinthemoney.com,https://tradeinthemoney.com,http://localhost:3000`
- Deployment evidence:
  - Staging backend redeployed from local backend source using Railway CLI (`railway up --ci`) and serving updated routes/gates.
- Strict live-gate execution evidence (local, staging backend):
  - `E2E_AI_COACH_MODE=live E2E_AI_COACH_REQUIRE_LIVE=true E2E_BACKEND_URL=https://itm-gd-staging.up.railway.app NEXT_PUBLIC_AI_COACH_API_URL=https://itm-gd-staging.up.railway.app E2E_BYPASS_TOKEN=e2e:00000000-0000-4000-8000-000000000001 pnpm test:e2e:ai-coach-live`
  - Result: `16 passed` (run 1)
  - Result: `16 passed` (run 2)
- GitHub workflow dispatch note:
  - `gh workflow run .github/workflows/ai-coach-live-e2e.yml --ref Aiupgrade ...` still requires workflow availability on default branch (`main`) for dispatch visibility.

Current checklist:

- [x] Staging GitHub secrets are configured.
- [x] Staging backend URL identified (`https://itm-gd-staging.up.railway.app`).
- [x] Local strict live-gate run executed against staging backend URL (`pnpm test:e2e:ai-coach-live`, strict mode).
- [x] `ai-coach-live-e2e.yml` GitHub workflow dispatch executed from `main`.
- [x] Workflow evidence captured in this status doc.
- [x] Staging migration-hardening verification completed.
- [x] Production promotion recommendation recorded.

GitHub live-gate evidence (`main`, 2026-02-09):

- Workflow: `AI Coach Live E2E`
- Run URL: `https://github.com/n8kahl/ITM-gd/actions/runs/21830645434`
- Commit SHA: `9224cdfdf468e9eaae4dbd0ecb39be6282e6aa47`
- Trigger: `workflow_dispatch` with `backend_url=https://itm-gd-staging.up.railway.app`
- Result: `success` (`ai-coach-live` job passed)
- Notable test annotation: `16 passed`

Production promotion recommendation:

- Recommendation: `GO` for production promotion of current AI Coach V2 implemented scope.
- Basis:
  - branch merged into `main`
  - strict staging gate validated locally and in GitHub workflow from default branch
  - staging health/auth/scanner/brief/tracked detector pathways validated end-to-end

Production deployment evidence (`main`, 2026-02-09):

- Railway target: `TradeITM / production / ITM-gd`
- Production domain: `https://itm-gd-production.up.railway.app`
- Deploy command: `cd backend && railway up --ci`
- Verification snapshots:
  - `GET /health` -> `200`
  - `GET /health/detailed` -> `200`
  - `GET /api/watchlist` (unauthenticated) -> `401` (expected)
  - `GET /api/options/:symbol/0dte` (unauthenticated) -> `401` (expected auth gate)
  - `GET /api/options/:symbol/iv` (unauthenticated) -> `401` (expected auth gate)

Earnings phase deployment status (2026-02-09, current):

- Commit: `a17821b` (`feat(ai-coach): ship phase 3 earnings module`)
- Git push: `main -> origin/main` complete.
- Backend deploy attempts:
  - `railway up --ci -s ITM-gd -e staging` retried multiple times.
  - `railway up --ci -s ITM-gd -e production` retried multiple times.
  - Result: blocked by Railway transport errors during upload (`received fatal alert: BadRecordMac` / `Broken pipe`).
- Live endpoint check while deploy is blocked:
  - `GET /api/earnings/calendar` on staging/production currently returns `404` (expected until new backend image is deployed).
