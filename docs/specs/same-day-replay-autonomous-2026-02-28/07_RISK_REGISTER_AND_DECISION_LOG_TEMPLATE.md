# Same-Day Replay â€” Risk Register & Decision Log

> **Created:** 2026-02-28  
> **Feature Spec:** `/Users/natekahl/ITM-gd/docs/specs/SAME_DAY_REPLAY_EXECUTION_SPEC_2026-02-28.md`

---

## Risk Register

| ID | Risk | Likelihood | Impact | Mitigation | Status |
|----|------|-----------|--------|------------|--------|
| R1 | Replay session retrieval ambiguity across multiple channels on same date | High | High | Canonicalize APIs on `session_id` (UUID), date only for filtering | Closed (Session 5 endpoint uses UUID-only lookup) |
| R2 | Missing/weak RLS on new replay tables | Medium | Critical | RLS contract in Phase 1 and advisor checks per migration | Closed (Session 1 baseline complete) |
| R3 | Historical dates before snapshot go-live lack analytical context | Certain | Medium | Partial-context mode with explicit labels; no inferred confluence fabrication | Open |
| R4 | Admin auth drift between frontend and backend replay surfaces | Low | High | Require `authenticateToken + requireAdmin` on all replay endpoints and add 403 tests | Open |
| R5 | Snapshot writes degrade live SPX loop performance | Medium | High | Batch writes, periodic lifecycle flush (`start/stop`), fail-open logging, p95 latency gate | Open |
| R6 | Unindexed replay FK paths may degrade joins at scale (`discord_parsed_trades.entry_snapshot_id`, `replay_drill_results.parsed_trade_id`) | Medium | Medium | Added covering indexes in Session 1b closeout hotfix | Closed |
| R7 | Replay V2 frame/type expansion could break existing V1 replay consumers | Medium | Medium | Keep `SPXReplayFrame` additions null-defaulted and avoid runtime data plumbing until later phases | Closed (Session 2) |
| R8 | Snapshot mapper can drift from evolving SPX analytics contracts (especially MTF/context fields) and silently persist partial context | Medium | Medium | Keep explicit null-safe mappings, add mapper unit tests, and gate runtime wiring to Phase 2.2 until integration tests land | Open |
| R9 | Setup transition capture can over-capture during rapid status churn and increase write volume | Medium | Medium | Deterministic transition detection keyed by `setup.id + status`, batched writer flush (`<=5`), and fail-open non-blocking capture path | Open |
| R10 | Discord connection may be interpreted as full ingest readiness before Phase 4.2 parser/state machine lands | Medium | Medium | Keep Phase 4.1 output strictly raw metadata callback only with no DB writes/parser side effects; document gating in tracker | Closed (Session 8 parser/state machine landed) |
| R11 | Discord listener instability or invalid guild/channel filter config could silently drop candidate messages | Medium | Medium | Idempotent start/stop lifecycle, config validation warnings, fail-open runtime error handling, and unit tests for filter behavior | Open |
| R12 | Deterministic parser rules may miss message variants outside the FancyITM lexicon and downgrade to commentary | Medium | Medium | Keep fail-open commentary classification, expand regex coverage incrementally with test fixtures, and reserve Phase 4.3+ fallback strategy for non-deterministic variants | Mitigated (Session 9 LLM fallback added for ambiguous commentary) |
| R13 | LLM fallback may return malformed or overfit signal envelopes that violate parser contract | Medium | High | Enforce strict Zod schema, coerce to typed contract, and fail-open back to deterministic commentary path on schema/transport/runtime failures | Open |
| R14 | Realtime broadcast failures could cause missed live Discord signal events during pipeline processing | Medium | Medium | Broadcast via fail-open non-throwing service, log non-ok statuses/errors, and keep bot handler resilient to async parser/broadcast failures | Open |
| R15 | Replay session list lookups may become ambiguous if default date window, date validation, and symbol-session filtering are inconsistent across clients | Medium | Medium | Enforce strict YYYY-MM-DD validation, document default 30-day inclusive window in response metadata, and apply deterministic symbol filtering through `discord_parsed_trades.session_id` matching | Mitigated (Session 11 list endpoint contract tests) |
| R16 | Replay trades lookup could leak ambiguous or non-deterministic drill-down ordering if trade filtering/sorting is not canonical by `session_id` and `trade_index` | Medium | Medium | Enforce UUID session lookup, verify session existence before trade read, apply optional uppercase symbol filter, and order by `trade_index ASC` with contract-tested response shape | Mitigated (Session 12 trades endpoint integration tests) |
| R17 | Replay detail endpoint may return inconsistent cross-surface payloads if snapshots/trades/messages are not assembled with deterministic ordering and scoped symbol filtering | Medium | High | Enforce canonical session lookup first, deterministic ordered reads (`captured_at`, `trade_index`, `sent_at` ascending), default symbol normalization, and contract tests covering symbol-scoped snapshots/trades with session-scoped messages | Mitigated (Session 13 detail endpoint integration tests) |
| R18 | Replay session browser UI may degrade operator trust if list/detail loading, 403 handling, and filter-driven selection states are inconsistent across desktop layouts | Medium | Medium | Keep deterministic shell states (loading/empty/error), show explicit admin-only 403 copy, and preserve canonical session-id selection behavior with strict lint/tsc gates in the current non-jsdom harness | Mitigated (Session 14 desktop shell validations) |
| R19 | Replay session browsing can remain noisy at high session volume if operators cannot constrain the list to a single trading day with deterministic grouping/order | Medium | Medium | Add compact day navigator from fetched session days, default to most recent day, preserve selected-day filtering/grouping with deterministic in-day ordering, and keep explicit empty/error state messaging | Mitigated (Session 15 calendar/day grouping refinement) |
| R20 | Full-session replay detail payload can be operationally brittle if market-data enrichment failures block otherwise valid session assembly | Medium | High | Isolate `bars` + `priorDayBar` enrichment in fail-open handling: log warning and return `{ bars: [], priorDayBar: null }` while preserving core session/snapshots/trades/messages payload and `503` only for core Supabase failures | Mitigated (Session 16 fail-open market enrichment tests) |
| R21 | Live Discord replay capture can silently fail if persistence introduces hard failures in bot runtime path | Medium | High | Keep persistence fail-open in pipeline (warn-only on DB errors), upsert canonical session rows by `(session_date, channel_id)`, and persist idempotent raw messages by `discord_msg_id` before broadcast | Mitigated (Session 17 persistence + pipeline tests) |
| R22 | Parsed trade lifecycle persistence can drift into inconsistent trade/message linkage if live signal transitions are not deterministically mapped to one open trade per session/channel | Medium | High | Maintain V1 per-session/channel lifecycle state, enforce deterministic `trade_index` progression, persist transition-specific updates (`entry`, lifecycle events, exits), and link signal messages through `parsed_trade_id` while preserving fail-open pipeline behavior | Mitigated (Session 18 lifecycle persistence tests) |
| R23 | Replay session browser list quality can degrade if `discord_trade_sessions` rollups lag lifecycle updates or derive non-deterministic PnL/trade counts | Medium | High | Recompute and persist session rollups on each persisted signal (`session_start/session_end/trade_count/net_pnl_pct`) using deterministic trade index + parseable closed-trade PnL aggregation, with unit and replay-list integration regression coverage | Mitigated (Session 19 rollup maintenance tests) |

---

## Decision Log

| ID | Decision | Rationale | Date | Phase |
|----|----------|-----------|------|-------|
| D1 | Use `session_id` as canonical replay identifier | Eliminates same-date/multi-channel ambiguity and gives deterministic drill navigation | 2026-02-28 | Scope |
| D2 | Keep Same-Day Replay admin-only in V1 | Reduces operational risk while schema/contracts stabilize | 2026-02-28 | Scope |
| D3 | Prioritize learner impact over historical breadth | Full context only where captured; partial-context labeling avoids false confidence | 2026-02-28 | Scope |
| D4 | Keep replay/session/discord table writes service-role only, with admin-only reads | Preserves ingest pipeline control while maintaining V1 admin gate for replay visibility | 2026-02-28 | Session 1 |
| D5 | Seed SPX symbol profile via idempotent upsert | Guarantees baseline SPX profile and preserves zero-behavior-change defaults across environments | 2026-02-28 | Session 1b |
| D6 | Land Phase 1.5-1.6 as type/env wiring only with null-safe frame extensions | Delivers shared contracts and config schema while preserving V1 runtime behavior and admin-gated access assumptions | 2026-02-28 | Session 2 |
| D7 | Land Phase 2.1 as isolated writer service with fail-open batched persistence and no loop/bootstrap integration | Preserves production behavior while validating mapping, env gate, market-hours guard, batching, and error swallowing before wiring | 2026-03-01 | Session 3 |
| D8 | Integrate replay capture in SPX snapshot cycle as fire-and-forget with deterministic status transition detection (`setup.id + status`) | Ensures interval + transition captures are recorded without blocking `getSPXSnapshot()` and preserves snapshot latency protections | 2026-03-01 | Session 4 |
| D9 | Add admin-only replay snapshot fetch endpoint keyed strictly by `session_id` UUID (no date fallback) | Preserves canonical identity for replay session lookups, enforces V1 admin-only replay contract, and prevents ambiguous same-date retrieval paths | 2026-03-01 | Session 5 |
| D10 | Add explicit replay writer lifecycle bootstrap controls (`start/stop`) and server wiring with fail-open shutdown flush | Ensures pending replay rows are periodically flushed during runtime and explicitly drained on shutdown without impacting startup/shutdown reliability | 2026-03-01 | Session 6 |
| D11 | Implement Phase 4.1 Discord bot lifecycle bootstrap with scoped `messageCreate` filtering and typed raw metadata callback only | Establishes deterministic connection/listener plumbing for configured guild/channel surfaces while intentionally deferring parser/state-machine logic to Phase 4.2+ | 2026-03-01 | Session 7 |
| D12 | Implement deterministic Discord message classifier/parser plus isolated trade lifecycle state machine (`IDLE -> STAGED -> ACTIVE -> CLOSED`) with implicit `ACTIVE + PREP` close-and-restage behavior | Delivers Phase 4.2 parsing semantics while keeping slice isolated from persistence, broadcaster, and fallback LLM logic | 2026-03-01 | Session 8 |
| D13 | Add Phase 4.3 asynchronous LLM fallback only for deterministic `commentary` outputs, with strict schema validation and fail-open coercion into typed parser contract | Preserves deterministic first-pass performance while improving ambiguous message coverage without introducing persistence or broadcast coupling | 2026-03-01 | Session 9 |
| D14 | Add Phase 4.4 realtime Discord broadcaster (`discord_calls:{channel_id}`) and wire bot message pipeline through parser fallback to broadcast event kinds | Delivers live signal fanout contract for downstream subscribers while maintaining no-persistence, no-route-change, fail-open behavior | 2026-03-01 | Session 10 |
| D15 | Implement `GET /api/spx/replay-sessions` as admin-only Phase 5.2a list endpoint with strict date validation, canonical `sessionId` rows, and symbol filtering via `discord_parsed_trades` session matches | Establishes deterministic replay session browser contract while keeping Session 11 scoped to list API only (no detail/trades endpoints or UI work) | 2026-03-01 | Session 11 |
| D16 | Implement `GET /api/spx/replay-sessions/:sessionId/trades` as admin-only Phase 5.2b endpoint with canonical session existence lookup and deterministic trade ordering | Delivers replay drill-down trade payloads without full-session assembly, preserves V1 admin gate, and keeps slice isolated from UI, DB writes, and additional endpoint surfaces | 2026-03-01 | Session 12 |
| D17 | Implement `GET /api/spx/replay-sessions/:sessionId` as admin-only Phase 5.2c detail endpoint assembling session metadata, snapshots, trades, and messages by canonical `sessionId` | Establishes single-call replay drill-down payload contract while preserving fail-open behavior and keeping slice isolated from UI, chart assembly, and database writes | 2026-03-01 | Session 13 |
| D18 | Implement Phase 5.1a desktop replay session browser UI shell that consumes existing list/detail APIs without chart-jump wiring | Delivers first operator-facing replay navigation card while keeping scope intentionally limited to sidebar shell, deterministic state handling, and no backend/data-model changes | 2026-03-01 | Session 14 |
| D19 | Add Phase 5.1b day navigator + selected-day grouping refinement in replay browser while preserving existing list/detail API integration | Improves desktop operator scanability and deterministic navigation (most-recent day default, explicit day-filtered empty states, and row-level badges) without backend changes, DB writes, or chart jump wiring | 2026-03-01 | Session 15 |
| D20 | Complete Phase 5.2d by enriching the existing replay session detail endpoint with Massive minute `bars` and optional prior-day range context | Delivers full-session replay payload contract (`bars`, `priorDayBar`) without changing endpoint path, while keeping symbol scoping semantics and fail-open enrichment so core session assembly remains reliable | 2026-03-01 | Session 16 |
| D21 | Implement Phase 4.5a Discord persistence foundation by inserting raw bot messages and upserting daily channel sessions before broadcast | Establishes production replay transcript/session capture without changing admin surface contracts, keeps parsed trade lifecycle writes deferred, and preserves fail-open live bot behavior | 2026-03-01 | Session 17 |
| D22 | Implement Phase 4.5b parsed trade lifecycle persistence and signal-to-trade linking in Discord ingest pipeline | Completes V1 structured replay capture by persisting `prep/fill/mutate/exit` transitions into `discord_parsed_trades` and linking `discord_messages.parsed_trade_id`, while preserving admin-only replay contract and fail-open runtime behavior | 2026-03-01 | Session 18 |
| D23 | Maintain `discord_trade_sessions` rollups inline during persistence (`session_start/session_end/trade_count/net_pnl_pct`) and keep parse->persist->broadcast fail-open ordering unchanged | Ensures replay session list fields remain accurate for operators without adding new routes or schema changes, while preserving non-blocking runtime semantics if persistence fails | 2026-03-01 | Session 19 |
